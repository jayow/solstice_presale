<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solstice Presale</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Typographic Scale - Base: 1rem (16px) */
        /* Scale: 0.75, 0.875, 1, 1.125, 1.25, 1.5, 2, 2.5, 3, 4 */
        
        html {
            font-size: 16px; /* Base font size */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
            min-height: 100vh;
            padding: 0;
            color: #ffffff;
            margin: 0;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            font-size: 1rem; /* Base: 16px */
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            margin: 20px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .header-top-right {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
        }

        .presale-countdown {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 10px;
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem; /* 14px */
            color: #ff6b35;
            text-align: right;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            min-height: 2.5rem; /* Match button height */
        }

        .presale-countdown-label {
            font-size: 0.75rem; /* 12px */
            opacity: 0.8;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
        }

        .presale-countdown-time {
            font-weight: 700;
            font-size: 1.125rem; /* 18px */
        }

        .join-presale-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: #0a0e27;
            border: none;
            border-radius: 10px;
            padding: 0.625rem 1.25rem;
            font-weight: 700;
            font-size: 0.875rem; /* 14px */
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 2.5rem;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .join-presale-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.5);
            background: linear-gradient(135deg, #f7931e 0%, #ff6b35 100%);
        }

        .header h1 {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #ff6b35 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.9375rem;
            font-size: 2rem; /* 32px - reduced from 48px */
            font-weight: 800;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            line-height: 1.2;
        }

        .program-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.875rem; /* 14px */
            margin-bottom: 1.25rem;
            word-break: break-all;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 107, 53, 0.2);
            color: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: rgba(255, 107, 53, 0.5);
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255, 107, 53, 0.2);
        }

        .stat-card h3 {
            font-size: 0.75rem; /* 12px */
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
        }

        .stat-card .value {
            font-size: 2rem; /* 32px - reduced from 40px */
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
        }

        .stat-card .subtitle {
            font-size: 0.75rem; /* 12px */
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .progress-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 20px;
            padding: 40px;
            margin: 20px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 20px;
        }

        .progress-title {
            font-size: 1.25rem; /* 20px */
            color: rgba(255, 255, 255, 0.9);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .progress-amount {
            font-size: 1.5rem; /* 24px - reduced from 32px */
            font-weight: 800;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .progress-percentage {
            font-size: 1.25rem; /* 20px - reduced from 48px, will be inside bar */
            font-weight: 800;
            color: #0a0e27;
            margin-bottom: 0;
            line-height: 1;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .progress-bar-container {
            width: 100%;
            height: 40px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid rgba(255, 107, 53, 0.2);
            margin-top: 20px;
            position: relative;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .progress-bar-container-wrapper {
            position: relative;
            width: 100%;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35 0%, #f7931e 50%, #ff6b35 100%);
            background-size: 200% 100%;
            border-radius: 20px;
            transition: width 0.5s ease-out;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .progress-target {
            display: flex;
            justify-content: space-between;
            margin-top: 0.9375rem;
            font-size: 0.875rem; /* 14px */
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .chart-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin: 20px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .chart-card h3 {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.5rem; /* 24px */
            font-weight: 700;
            margin-bottom: 1.25rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            line-height: 1.3;
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .timeframe-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            font-size: 0.875rem; /* 14px */
            font-weight: 700;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .timeframe-btn:hover {
            background: rgba(255, 107, 53, 0.2);
            border-color: rgba(255, 107, 53, 0.5);
            transform: translateY(-2px);
        }

        .timeframe-btn.active {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border-color: #ff6b35;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 1.25rem;
            margin-top: 0.9375rem;
            font-size: 0.75rem; /* 12px */
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .progress-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .progress-info-item {
            text-align: center;
        }

        .progress-info-label {
            font-size: 0.75rem; /* 12px */
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .transactions-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-height: 75vh;
            overflow-y: auto;
        }
        
        .transactions-count {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.875rem; /* 14px */
            margin-bottom: 0.9375rem;
            padding-bottom: 0.9375rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .filters-section {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 0.75rem; /* 12px */
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .filter-input,
        .filter-select {
            padding: 0.75rem 1rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.875rem; /* 14px */
            color: #ffffff;
            transition: all 0.2s;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .filter-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem; /* 14px */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #f7931e 0%, #ff6b35 100%);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .panel-header h2 {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.5rem; /* 24px - reduced from 32px */
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            line-height: 1.3;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.875rem; /* 14px */
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .transactions-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            background: transparent;
            border-radius: 12px;
            overflow: hidden;
        }

        .transactions-table thead {
            background: rgba(255, 107, 53, 0.1);
            border-bottom: 2px solid rgba(255, 107, 53, 0.3);
        }

        .transactions-table th {
            padding: 1.125rem 1.25rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.75rem; /* 12px */
            text-transform: uppercase;
            letter-spacing: 1.5px;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: all 0.2s;
            color: rgba(255, 255, 255, 0.9);
        }

        .transactions-table th:hover {
            background-color: rgba(255, 107, 53, 0.15);
            color: #ff6b35;
        }

        .transactions-table th.sortable::after {
            content: ' ↕';
            opacity: 0.4;
            font-size: 0.8rem; /* 12.8px */
            color: rgba(255, 107, 53, 0.6);
        }

        .transactions-table th.sort-asc::after {
            content: ' ↑';
            opacity: 1;
            color: #ff6b35;
        }

        .transactions-table th.sort-desc::after {
            content: ' ↓';
            opacity: 1;
            color: #ff6b35;
        }

        .transactions-table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }

        .transactions-table tbody tr:hover {
            background-color: rgba(255, 107, 53, 0.05);
        }

        .transactions-table tbody tr.new {
            background-color: rgba(255, 107, 53, 0.1);
            border-left: 3px solid #ff6b35;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .transactions-table td {
            padding: 1.125rem 1.25rem;
            font-size: 0.875rem; /* 14px */
            color: rgba(255, 255, 255, 0.9);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .table-date {
            color: rgba(255, 255, 255, 0.7);
        }

        .table-source {
            color: rgba(255, 107, 53, 0.9);
            word-break: break-all;
        }

        .table-amount {
            font-weight: bold;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: right;
        }

        .table-tx-id {
            font-size: 0.75rem; /* 12px */
        }

        .table-tx-id a {
            color: rgba(255, 107, 53, 0.9);
            text-decoration: none;
            transition: all 0.2s;
        }

        .table-tx-id a:hover {
            color: #ff6b35;
            text-decoration: underline;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.75rem; /* 12px */
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.3125rem;
        }

        .detail-value {
            font-size: 0.875rem; /* 14px */
            color: #333;
            word-break: break-all;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.8rem; /* 12.8px */
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .type-badge.type-deposit {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.4);
        }

        .type-badge.type-refund {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.4);
        }

        .type-badge.type-transfer {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .type-badge.type-unknown {
            background: rgba(158, 158, 158, 0.2);
            color: #9e9e9e;
            border: 1px solid rgba(158, 158, 158, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 3.75rem 1.25rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            font-size: 0.875rem; /* 14px */
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Scrollbar styling */
        .transactions-panel::-webkit-scrollbar {
            width: 8px;
        }

        .transactions-panel::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
        }

        .transactions-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 107, 53, 0.5);
            border-radius: 10px;
        }

        .transactions-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 107, 53, 0.7);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem; /* 28.8px on mobile */
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .transaction-header {
                flex-direction: column;
                gap: 10px;
            }

            .transaction-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top-right">
                <div class="presale-countdown">
                    <div class="presale-countdown-label">Presale Ends</div>
                    <div class="presale-countdown-time" id="presaleEndCountdown">--:--:--:--</div>
                </div>
                <a href="https://app.legion.cc?homie=E2EFA43C" target="_blank" rel="noopener noreferrer" class="join-presale-btn">
                    Join Presale
                </a>
            </div>
            <h1>Solstice Presale</h1>
            
            <div class="progress-card">
                <div class="progress-header">
                    <div class="progress-title">Fundraising Progress</div>
                </div>
                <div class="progress-info">
                    <div class="progress-info-item">
                        <div class="progress-info-label">Current Amount</div>
                        <div class="progress-amount" id="currentAmount">$0.00</div>
                    </div>
                    <div class="progress-info-item">
                        <div class="progress-info-label">Target Amount</div>
                        <div class="progress-amount" style="font-size: 2rem;">$4,000,000</div>
                    </div>
                    <div class="progress-info-item">
                        <div class="progress-info-label">Hard Cap</div>
                        <div class="progress-amount" style="font-size: 2rem;">$6,500,000</div>
                    </div>
                </div>
                <div class="progress-bar-container-wrapper">
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="progressBar"></div>
                        <div class="progress-percentage" id="progressPercentage">0.00%</div>
                    </div>
                </div>
                <div class="progress-target">
                    <span>$0</span>
                    <span id="progressText">0% of $4M target</span>
                    <span>$6,500,000</span>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>Amount Over Time</h3>
                <div class="chart-controls">
                    <button class="timeframe-btn active" data-timeframe="1h" onclick="setTimeframe('1h')">1 Hour</button>
                    <button class="timeframe-btn" data-timeframe="6h" onclick="setTimeframe('6h')">6 Hours</button>
                    <button class="timeframe-btn" data-timeframe="24h" onclick="setTimeframe('24h')">24 Hours</button>
                    <button class="timeframe-btn" data-timeframe="7d" onclick="setTimeframe('7d')">7 Days</button>
                    <button class="timeframe-btn" data-timeframe="30d" onclick="setTimeframe('30d')">30 Days</button>
                    <button class="timeframe-btn" data-timeframe="all" onclick="setTimeframe('all')">All Time</button>
                </div>
                <div class="chart-container">
                    <canvas id="amountChart"></canvas>
                </div>
                <div class="chart-legend">
                    <div class="chart-legend-item">
                        <div class="chart-legend-color" style="background: #ff6b35;"></div>
                        <span>Drag to pan, scroll to zoom</span>
                    </div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Amount</h3>
                    <div class="value" id="totalAmount">$0.00</div>
                    <div class="subtitle">USDC Transferred</div>
                </div>
                <div class="stat-card">
                    <h3>Total Transactions</h3>
                    <div class="value" id="totalTransactions">0</div>
                    <div class="subtitle">Transfer Events</div>
                </div>
                <div class="stat-card">
                    <h3>Refunds</h3>
                    <div class="value" id="refundAmount">$0</div>
                    <div class="subtitle" id="refundCount">0 transactions</div>
                </div>
                <div class="stat-card">
                    <h3>New This Session</h3>
                    <div class="value" id="newTransactions">0</div>
                    <div class="subtitle">Since Page Load</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="transactions-panel">
                <div class="panel-header">
                    <h2>Recent Transactions</h2>
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span class="status-text" id="statusText">Monitoring...</span>
                    </div>
                </div>
                
                <div class="filters-section">
                    <div class="filter-group">
                        <label class="filter-label">Date From</label>
                        <input type="datetime-local" class="filter-input" id="filterDateFrom" placeholder="Start date">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Date To</label>
                        <input type="datetime-local" class="filter-input" id="filterDateTo" placeholder="End date">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Source Address</label>
                        <input type="text" class="filter-input" id="filterSource" placeholder="Filter by source...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Min Amount (USDC)</label>
                        <input type="number" class="filter-input" id="filterMinAmount" placeholder="0" step="0.01">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Max Amount (USDC)</label>
                        <input type="number" class="filter-input" id="filterMaxAmount" placeholder="No limit" step="0.01">
                    </div>
                    <div class="filter-buttons">
                        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                        <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                    </div>
                </div>
                
                <div class="transactions-count" id="transactionsCount" style="display: none;">
                    Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> transactions
                </div>
                <div class="transactions-list" id="transactionsList">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p>Waiting for transactions...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use relative path for Vercel deployment, fallback to localhost for development
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000/api' 
            : '/api';
        const TARGET_AMOUNT = 4000000; // $4M target raise
        const HARD_CAP_AMOUNT = 6500000; // $6.5M hard cap
        let totalAmount = 0;
        let totalTransactions = 0;
        let newTransactionsCount = 0;
        let refundAmount = 0;
        let refundCount = 0;
        let transactions = [];
        let filteredTransactions = [];
        let initialLoadComplete = false;
        let currentFilters = {
            dateFrom: null,
            dateTo: null,
            source: '',
            minAmount: null,
            maxAmount: null
        };
        let sortColumn = 'date';
        let sortDirection = 'desc'; // 'asc' or 'desc'

        function formatAmount(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function formatAmountWithDecimals(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatAddress(address) {
            if (!address) return 'N/A';
            return `${address.substring(0, 8)}...${address.substring(address.length - 8)}`;
        }

        function formatTransactionId(txId) {
            if (!txId) return 'N/A';
            return `${txId.substring(0, 16)}...${txId.substring(txId.length - 16)}`;
        }

        function addTransaction(transfer) {
            // Check if transaction already exists (avoid duplicates)
            const exists = transactions.some(t => t.transaction_id === transfer.transaction_id);
            if (exists) {
                return; // Skip if already exists
            }
            
            // Ensure transfer_type is included
            if (!transfer.transfer_type && transfer.direction) {
                transfer.transfer_type = transfer.direction === 'out' ? 'deposit' : transfer.direction === 'in' ? 'refund' : '';
            }
            
            // Add to beginning of list (newest first)
            transactions.unshift(transfer);
            
            // Update transaction count
            totalTransactions++;
            newTransactionsCount++;
            
            // Don't update totalAmount here - it should come from API stats (deposits - refunds)
            // Adding individual amounts would incorrectly include refunds
            // Instead, refresh stats from API to get accurate net amount
            loadInitialStats();
            
            // Update UI
            updateStats();
            filterTransactions(); // Re-apply filters and render
        }

        function updateStats() {
            document.getElementById('totalAmount').textContent = formatAmount(totalAmount);
            document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
            document.getElementById('newTransactions').textContent = newTransactionsCount.toLocaleString();
            
            // Update refund stats if elements exist
            const refundAmountEl = document.getElementById('refundAmount');
            const refundCountEl = document.getElementById('refundCount');
            if (refundAmountEl) {
                refundAmountEl.textContent = formatAmount(refundAmount);
            }
            if (refundCountEl) {
                refundCountEl.textContent = refundCount.toLocaleString() + ' transactions';
            }
            
            updateProgressBar();
        }

        function updateProgressBar() {
            // Calculate percentage based on target ($4M), but cap at hard cap ($6.5M)
            let percentage = (totalAmount / TARGET_AMOUNT) * 100;
            
            // If we exceed the hard cap, show 100% but indicate we're over
            if (totalAmount >= HARD_CAP_AMOUNT) {
                percentage = 100;
            } else if (totalAmount > TARGET_AMOUNT) {
                // If we're between target and hard cap, show percentage of target but indicate we're over target
                percentage = Math.min(percentage, 100);
            } else {
                percentage = Math.min(percentage, 100);
            }
            
            const percentageText = percentage.toFixed(2);
            
            // Update progress bar width (cap at 100% visually)
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${Math.min(percentage, 100)}%`;
            
            // Update percentage display (inside progress bar - just show percentage)
            let displayText = `${percentageText}%`;
            if (totalAmount >= HARD_CAP_AMOUNT) {
                displayText = '100%';
            }
            document.getElementById('progressPercentage').textContent = displayText;
            
            // Update current amount
            document.getElementById('currentAmount').textContent = formatAmount(totalAmount);
            
            // Update progress text
            let progressText = '';
            if (totalAmount >= HARD_CAP_AMOUNT) {
                progressText = 'Hard Cap Reached';
            } else if (totalAmount > TARGET_AMOUNT) {
                progressText = `${percentageText}% of $4M target (Hard Cap: $6.5M)`;
            } else {
                progressText = `${percentageText}% of $4M target`;
            }
            document.getElementById('progressText').textContent = progressText;
        }

        function parseDateFilter(dateString) {
            if (!dateString) return null;
            // Convert datetime-local format to Date object
            return new Date(dateString);
        }

        function parseUTCString(utcString) {
            // Parse "2025-12-22 14:16:22 UTC" format
            if (!utcString || !utcString.includes('UTC')) return null;
            const datePart = utcString.replace(' UTC', '').replace(' ', 'T');
            return new Date(datePart + 'Z');
        }

        function applyFilters() {
            const dateFrom = parseDateFilter(document.getElementById('filterDateFrom').value);
            const dateTo = parseDateFilter(document.getElementById('filterDateTo').value);
            const sourceFilter = document.getElementById('filterSource').value.toLowerCase();
            const minAmount = parseFloat(document.getElementById('filterMinAmount').value) || null;
            const maxAmount = parseFloat(document.getElementById('filterMaxAmount').value) || null;
            
            currentFilters = {
                dateFrom: dateFrom,
                dateTo: dateTo,
                source: sourceFilter,
                minAmount: minAmount,
                maxAmount: maxAmount
            };
            
            filterTransactions();
        }

        function clearFilters() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterSource').value = '';
            document.getElementById('filterMinAmount').value = '';
            document.getElementById('filterMaxAmount').value = '';
            
            currentFilters = {
                dateFrom: null,
                dateTo: null,
                source: '',
                minAmount: null,
                maxAmount: null
            };
            
            filterTransactions();
        }

        function filterTransactions() {
            filteredTransactions = transactions.filter(transfer => {
                // Date from filter
                if (currentFilters.dateFrom) {
                    const transferDate = parseUTCString(transfer.blocktime_utc);
                    if (!transferDate || transferDate < currentFilters.dateFrom) {
                        return false;
                    }
                }
                
                // Date to filter
                if (currentFilters.dateTo) {
                    const transferDate = parseUTCString(transfer.blocktime_utc);
                    // Add one day to include the entire end date
                    const endDate = new Date(currentFilters.dateTo);
                    endDate.setHours(23, 59, 59, 999);
                    if (!transferDate || transferDate > endDate) {
                        return false;
                    }
                }
                
                // Source filter
                if (currentFilters.source && 
                    !transfer.source.toLowerCase().includes(currentFilters.source)) {
                    return false;
                }
                
                // Min amount filter
                if (currentFilters.minAmount !== null && 
                    transfer.amount < currentFilters.minAmount) {
                    return false;
                }
                
                // Max amount filter
                if (currentFilters.maxAmount !== null && 
                    transfer.amount > currentFilters.maxAmount) {
                    return false;
                }
                
                return true;
            });
            
            renderTransactions();
        }

        function renderTransactions() {
            const list = document.getElementById('transactionsList');
            const countDiv = document.getElementById('transactionsCount');
            const transactionsToShow = filteredTransactions.length > 0 ? filteredTransactions : transactions;
            
            // Update count display
            if (transactions.length > 0) {
                countDiv.style.display = 'block';
                document.getElementById('showingCount').textContent = transactionsToShow.length.toLocaleString();
                document.getElementById('totalCount').textContent = transactions.length.toLocaleString();
            } else {
                countDiv.style.display = 'none';
            }
            
            if (transactionsToShow.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p>${transactions.length === 0 ? 'Waiting for transactions...' : 'No transactions match the filters'}</p>
                    </div>
                `;
                return;
            }

            // Sort transactions
            const sortedTransactions = [...transactionsToShow].sort((a, b) => {
                let aVal, bVal;
                
                if (sortColumn === 'date') {
                    aVal = parseUTCString(a.blocktime_utc) || new Date(0);
                    bVal = parseUTCString(b.blocktime_utc) || new Date(0);
                } else if (sortColumn === 'source') {
                    aVal = (a.source || '').toLowerCase();
                    bVal = (b.source || '').toLowerCase();
                } else if (sortColumn === 'type') {
                    // Sort by transfer_type or direction
                    aVal = (a.transfer_type || a.direction || '').toLowerCase();
                    bVal = (b.transfer_type || b.direction || '').toLowerCase();
                } else if (sortColumn === 'amount') {
                    aVal = a.amount || 0;
                    bVal = b.amount || 0;
                } else if (sortColumn === 'txid') {
                    aVal = (a.transaction_id || '').toLowerCase();
                    bVal = (b.transaction_id || '').toLowerCase();
                }
                
                if (sortColumn === 'date' || sortColumn === 'amount') {
                    return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                } else {
                    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                }
            });
            
            // Render as table
            list.innerHTML = `
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th class="sortable ${sortColumn === 'date' ? `sort-${sortDirection}` : ''}" onclick="sortTable('date')">Date (UTC)</th>
                            <th class="sortable ${sortColumn === 'source' ? `sort-${sortDirection}` : ''}" onclick="sortTable('source')">Source</th>
                            <th class="sortable ${sortColumn === 'type' ? `sort-${sortDirection}` : ''}" onclick="sortTable('type')">Type</th>
                            <th class="sortable ${sortColumn === 'amount' ? `sort-${sortDirection}` : ''}" style="text-align: right;" onclick="sortTable('amount')">Amount</th>
                            <th class="sortable ${sortColumn === 'txid' ? `sort-${sortDirection}` : ''}" onclick="sortTable('txid')">Transaction ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedTransactions.map((transfer, index) => {
                            const isNew = index < 5; // Mark first 5 as new
                            const txId = transfer.transaction_id || '';
                            const txIdShort = txId ? `${txId.substring(0, 8)}...${txId.substring(txId.length - 8)}` : 'N/A';
                            const solscanUrl = txId ? `https://solscan.io/tx/${txId}` : '#';
                            // Determine transaction type
                            let transferType = 'Unknown';
                            let typeClass = 'type-unknown';
                            if (transfer.transfer_type) {
                                transferType = transfer.transfer_type.charAt(0).toUpperCase() + transfer.transfer_type.slice(1);
                                typeClass = transfer.transfer_type === 'deposit' ? 'type-deposit' : transfer.transfer_type === 'refund' ? 'type-refund' : 'type-transfer';
                            } else if (transfer.direction) {
                                // Fallback to direction if transfer_type not available
                                transferType = transfer.direction === 'out' ? 'Deposit' : transfer.direction === 'in' ? 'Refund' : 'Unknown';
                                typeClass = transfer.direction === 'out' ? 'type-deposit' : transfer.direction === 'in' ? 'type-refund' : 'type-unknown';
                            }
                            
                            return `
                                <tr class="${isNew ? 'new' : ''}">
                                    <td class="table-date">${transfer.blocktime_utc || 'N/A'}</td>
                                    <td class="table-source">${transfer.source || 'N/A'}</td>
                                    <td class="table-type"><span class="type-badge ${typeClass}">${transferType}</span></td>
                                    <td class="table-amount">${transfer.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} USDC</td>
                                    <td class="table-tx-id">
                                        ${txId ? `<a href="${solscanUrl}" target="_blank" rel="noopener noreferrer" title="${txId}">${txIdShort}</a>` : 'N/A'}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function sortTable(column) {
            if (sortColumn === column) {
                // Toggle direction if clicking same column
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, default to descending
                sortColumn = column;
                sortDirection = 'desc';
            }
            renderTransactions();
        }

        async function checkForNewTransfers() {
            // Don't check for new transfers until initial load is complete
            if (!initialLoadComplete) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/new-transfers`);
                const data = await response.json();
                
                if (data.new_transfers && data.new_transfers.length > 0) {
                    // Only add truly new transactions (not already in our list)
                    let addedCount = 0;
                    data.new_transfers.forEach(transfer => {
                        const beforeCount = transactions.length;
                        addTransaction(transfer);
                        if (transactions.length > beforeCount) {
                            addedCount++;
                        }
                    });
                    
                    if (addedCount > 0) {
                        // Update status
                        document.getElementById('statusText').textContent = 
                            `Found ${addedCount} new transaction(s)`;
                        
                        // Update chart with new data
                        loadChartData();
                        
                        // Reset status after 3 seconds
                        setTimeout(() => {
                            document.getElementById('statusText').textContent = 'Monitoring...';
                        }, 3000);
                    }
                } else {
                    document.getElementById('statusText').textContent = 'Monitoring...';
                }
            } catch (error) {
                console.error('Error fetching transfers:', error);
                document.getElementById('statusText').textContent = 'Connection error';
            }
        }

        async function loadInitialStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const data = await response.json();
                
                totalAmount = data.total_amount || 0;
                totalTransactions = data.total_transfers || 0;
                
                // Get refund stats if available
                if (data.refunds) {
                    refundAmount = data.refunds.amount || 0;
                    refundCount = data.refunds.count || 0;
                }
                
                updateStats();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function checkBackfillStatus() {
            try {
                const response = await fetch(`${API_BASE}/backfill-status`);
                const data = await response.json();
                
                if (data.backfill_in_progress) {
                    document.getElementById('statusText').textContent = 
                        `Loading historical data... (${data.seen_signatures} transactions processed)`;
                } else if (data.backfill_complete) {
                    // Update totals from backfill
                    totalAmount = data.total_amount || 0;
                    totalTransactions = data.total_transfers || 0;
                    updateStats();
                    
                    document.getElementById('statusText').textContent = 
                        `Monitoring for new transactions...`;
                }
            } catch (error) {
                console.error('Error checking backfill status:', error);
            }
        }

        // Chart setup
        let amountChart = null;
        let allChartData = { labels: [], amounts: [] };
        let currentTimeframe = 'all';

        function initChart() {
            const ctx = document.getElementById('amountChart');
            if (!ctx) return;

            amountChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cumulative Amount (USDC)',
                        data: [],
                        borderColor: '#ff6b35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#ff6b35',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: 'rgba(255, 255, 255, 0.9)',
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#ff6b35',
                            bodyColor: 'rgba(255, 255, 255, 0.9)',
                            borderColor: 'rgba(255, 107, 53, 0.3)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `Amount: $${context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', {maximumFractionDigits: 0});
                                },
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        function setTimeframe(timeframe) {
            currentTimeframe = timeframe;
            
            // Update button states
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-timeframe="${timeframe}"]`).classList.add('active');
            
            // Filter data based on timeframe
            filterChartData(timeframe);
        }

        function filterChartData(timeframe) {
            if (!amountChart || !allChartData.labels || allChartData.labels.length === 0) {
                return;
            }

            const now = new Date();
            let cutoffTime = null;

            switch(timeframe) {
                case '1h':
                    cutoffTime = new Date(now.getTime() - 60 * 60 * 1000);
                    break;
                case '6h':
                    cutoffTime = new Date(now.getTime() - 6 * 60 * 60 * 1000);
                    break;
                case '24h':
                    cutoffTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    break;
                case '7d':
                    cutoffTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case '30d':
                    cutoffTime = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                default:
                    // Show all data
                    amountChart.data.labels = allChartData.labels;
                    amountChart.data.datasets[0].data = allChartData.amounts;
                    amountChart.update('none');
                    // Reset zoom if available
                    try {
                        if (amountChart.resetZoom) {
                            amountChart.resetZoom();
                        }
                    } catch (e) {
                        // Zoom plugin might not be loaded
                    }
                    return;
            }

            // Filter data based on cutoff time
            const filteredLabels = [];
            const filteredAmounts = [];
            
            for (let i = 0; i < allChartData.labels.length; i++) {
                const label = allChartData.labels[i];
                // Parse the label (format: "YYYY-MM-DD HH:MM UTC")
                const labelDate = new Date(label.replace(' UTC', ''));
                
                if (labelDate >= cutoffTime) {
                    filteredLabels.push(label);
                    filteredAmounts.push(allChartData.amounts[i]);
                }
            }

            // Update chart
            amountChart.data.labels = filteredLabels;
            amountChart.data.datasets[0].data = filteredAmounts;
            amountChart.update('none');
            
            // Reset zoom when changing timeframe
            try {
                if (amountChart.resetZoom) {
                    amountChart.resetZoom();
                }
            } catch (e) {
                // Zoom plugin might not be loaded
            }
        }

        async function loadChartData() {
            try {
                const response = await fetch(`${API_BASE}/chart-data`);
                const data = await response.json();
                
                if (data.labels && data.amounts && amountChart) {
                    // Store all data
                    allChartData.labels = data.labels;
                    allChartData.amounts = data.amounts;
                    
                    // Apply current timeframe filter
                    filterChartData(currentTimeframe);
                }
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        // Presale end countdown: December 25, 2025, 1 PM UTC
        const PRESALE_END_DATE = new Date('2025-12-25T13:00:00Z');
        
        function updatePresaleEndCountdown() {
            const now = new Date();
            const diff = PRESALE_END_DATE - now;
            
            const countdownEl = document.getElementById('presaleEndCountdown');
            if (!countdownEl) return;
            
            if (diff <= 0) {
                countdownEl.textContent = 'ENDED';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            countdownEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }
        
        // Update countdown every second
        setInterval(updatePresaleEndCountdown, 1000);
        updatePresaleEndCountdown(); // Initial call
        
        // Initial load
        console.log('🚀 Initializing dashboard...');
        console.log('API_BASE:', API_BASE);
        loadInitialStats();
        checkBackfillStatus();
        initChart();
        
        // Load ALL existing transactions from API (only once on page load)
        async function loadExistingTransactions() {
            console.log('📥 loadExistingTransactions called, initialLoadComplete:', initialLoadComplete);
            if (initialLoadComplete) {
                return; // Already loaded, don't reload
            }
            
            try {
                console.log('📡 Starting to fetch transactions from:', `${API_BASE}/transfers`);
                document.getElementById('statusText').textContent = 'Loading all transactions...';
                
                // Load all transactions in batches
                let allTransfers = [];
                let offset = 0;
                const limit = 1000; // Fetch 1000 at a time
                let hasMore = true;
                
                while (hasMore) {
                    try {
                        const url = `${API_BASE}/transfers?limit=${limit}&offset=${offset}`;
                        console.log(`📥 Fetching batch: offset=${offset}, limit=${limit}`);
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log(`✅ Received ${data.transfers?.length || 0} transactions in this batch`);
                        
                        if (data.transfers && data.transfers.length > 0) {
                            allTransfers = allTransfers.concat(data.transfers);
                            offset += data.transfers.length; // Use actual count, not limit
                            
                            // Update status
                            document.getElementById('statusText').textContent = 
                                `Loading transactions... (${allTransfers.length} loaded)`;
                            
                            // Check if there are more - if we got fewer than requested, we're done
                            if (data.transfers.length < limit) {
                                hasMore = false;
                            }
                        } else {
                            hasMore = false;
                        }
                    } catch (fetchError) {
                        console.error('Error fetching transactions batch:', fetchError);
                        // If we have some transactions, continue with what we have
                        if (allTransfers.length > 0) {
                            console.log(`Continuing with ${allTransfers.length} transactions loaded so far`);
                            hasMore = false;
                        } else {
                            throw fetchError; // Re-throw if we have nothing
                        }
                    }
                }
                
                if (allTransfers.length > 0) {
                    // Convert database format to display format
                    const existingTransfers = allTransfers.map(t => {
                        // Ensure blocktime_utc is properly formatted
                        let blocktime_utc = t.blocktime_utc;
                        if (!blocktime_utc && t.blocktime) {
                            // Convert Unix timestamp to UTC string
                            const dt = new Date(t.blocktime * 1000);
                            blocktime_utc = dt.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
                        }
                        
                        return {
                            source: t.source || '',
                            blocktime: t.blocktime || 0,
                            blocktime_utc: blocktime_utc || '',
                            transaction_id: t.transaction_id || '',
                            amount: parseFloat(t.amount) || 0,
                            direction: t.direction || '',
                            transfer_type: t.transfer_type || '',
                            timestamp: t.blocktime || 0
                        };
                    });
                    
                    // Sort by timestamp descending (newest first)
                    existingTransfers.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    transactions = existingTransfers;
                    
                    // Get totals from API (net amount = deposits - refunds)
                    // Don't recalculate by summing all transactions, as that would include refunds
                    try {
                        const statsResponse = await fetch(`${API_BASE}/stats`);
                        const statsData = await statsResponse.json();
                        totalAmount = statsData.total_amount || 0; // Net amount from API
                        totalTransactions = statsData.total_transfers || transactions.length;
                        
                        // Get refund stats if available
                        if (statsData.refunds) {
                            refundAmount = statsData.refunds.amount || 0;
                            refundCount = statsData.refunds.count || 0;
                        }
                        
                        console.log(`📊 Using API stats: Net amount = $${totalAmount.toLocaleString()}, Total transfers = ${totalTransactions}, Refunds = $${refundAmount.toLocaleString()} (${refundCount} transactions)`);
                    } catch (statsError) {
                        console.error('Error fetching stats for total:', statsError);
                        // Fallback: use transaction count but don't sum amounts (would be wrong)
                        totalTransactions = transactions.length;
                        // Keep totalAmount from initial load or use 0
                    }
                    updateStats();
                    
                    initialLoadComplete = true;
                    filterTransactions();
                    
                    // Load chart data after transactions are loaded
                    loadChartData();
                    
                    document.getElementById('statusText').textContent = 
                        `Loaded ${transactions.length} transactions - Monitoring for new ones...`;
                    
                    console.log(`✓ Loaded ${transactions.length} existing transactions`);
                    console.log('Sample transactions:', transactions.slice(0, 3));
                    console.log('Calling filterTransactions to render...');
                } else {
                    initialLoadComplete = true;
                    document.getElementById('statusText').textContent = 'No existing transactions - Monitoring...';
                    console.log('No existing transactions found in database');
                }
            } catch (error) {
                console.error('Error loading existing transactions:', error);
                console.error('Error stack:', error.stack);
                initialLoadComplete = true; // Mark as complete even on error to prevent retries
                document.getElementById('statusText').textContent = `Error loading transactions: ${error.message}`;
            }
        }
        
        // Call loadExistingTransactions immediately on page load
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOM loaded, calling loadExistingTransactions');
                loadExistingTransactions();
            });
        } else {
            console.log('DOM already loaded, calling loadExistingTransactions');
            loadExistingTransactions();
        }
        
        // Check backfill status every 2 seconds until complete
        const backfillCheckInterval = setInterval(async () => {
            await checkBackfillStatus();
            try {
                const response = await fetch(`${API_BASE}/backfill-status`);
                const data = await response.json();
                if (data.backfill_complete && !data.backfill_in_progress) {
                    clearInterval(backfillCheckInterval);
                    // Load existing transactions if not already loaded
                    if (!initialLoadComplete) {
                        console.log('Backfill complete, loading existing transactions...');
                        await loadExistingTransactions();
                    }
                    // Start checking for new transfers
                    checkForNewTransfers();
                }
            } catch (error) {
                console.error('Error in backfill check:', error);
                // Continue checking
            }
        }, 2000);
        
        // Check for new transfers every minute (only after initial load)
        setInterval(() => {
            if (initialLoadComplete) {
                checkForNewTransfers();
            }
        }, 60000);
        
        // Allow Enter key to apply filters
        document.getElementById('filterSource').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') applyFilters();
        });
        document.getElementById('filterMinAmount').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') applyFilters();
        });
        document.getElementById('filterMaxAmount').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') applyFilters();
        });
        
        // Auto-apply filters on date change
        document.getElementById('filterDateFrom').addEventListener('change', applyFilters);
        document.getElementById('filterDateTo').addEventListener('change', applyFilters);
    </script>
</body>
</html>

